name: Save Bot History

on:
  schedule:
    - cron: '0,30 * * * *'
  workflow_dispatch:

jobs:
  save-history:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Download current stats
      run: |
        echo "Downloading current stats..."
        curl -s -o current.json "https://raw.githubusercontent.com/dimb9ih/dimb9ih.github.io/master/ifbot_stats.json"
        
        if [ -s current.json ]; then
          echo "Download successful"
        else
          echo "Download failed"
          exit 1
        fi
        
    - name: Save to history
      run: |
        mkdir -p history
        TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
        FILENAME="ifbot_${TIMESTAMP}.json"
        
        if [ -f current.json ]; then
          cp current.json "history/${FILENAME}"
          echo "Saved: ${FILENAME}"
        else
          echo "No current.json file"
          exit 1
        fi
        
    - name: Update filelist
      run: |
        ls -1 history/ifbot_*.json 2>/dev/null | sort -r > history/filelist.txt || echo "No files yet" > history/filelist.txt
        echo "Total files: $(wc -l history/filelist.txt | cut -d' ' -f1)" >> history/filelist.txt
        
    - name: Create summary.json
      run: |
        echo "Creating summary.json..."
        
        # Получаем последние 24 файла
        LATEST_FILES=$(ls -1t history/ifbot_*.json 2>/dev/null | head -24)
        
        # Начинаем формировать JSON
        echo '{"updated":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'","count":0,"data":[' > history/summary.json
        
        COUNT=0
        FIRST=1
        
        # Обрабатываем файлы в обратном порядке (от старых к новым)
        for file in $(echo "$LATEST_FILES" | tac); do
          if [ -f "$file" ]; then
            # Извлекаем данные с помощью jq
            TIMESTAMP=$(jq -r '.timestamp // 0' "$file" 2>/dev/null || echo "0")
            CPU=$(jq -r '.system_stats.cpu.utilization_percent // 0' "$file" 2>/dev/null || echo "0")
            RAM=$(jq -r '.system_stats.memory.utilization_percent // 0' "$file" 2>/dev/null || echo "0")
            ERRORS=$(jq -r '.error_stats.errors // 0' "$file" 2>/dev/null || echo "0")
            WARNINGS=$(jq -r '.error_stats.warnings // 0' "$file" 2>/dev/null || echo "0")
            CYCLE=$(jq -r '.cycle_count // 0' "$file" 2>/dev/null || echo "0")
            BATTERY=$(jq -r '.battery_info.battery_level // 0' "$file" 2>/dev/null || echo "0")
            
            # Преобразуем battery в целое число
            BATTERY_INT=$(printf "%.0f" "$BATTERY" 2>/dev/null || echo "0")
            
            if [ "$TIMESTAMP" != "0" ]; then
              if [ "$FIRST" -eq 1 ]; then
                FIRST=0
              else
                echo -n "," >> history/summary.json
              fi
              
              echo -n '{"t":'$TIMESTAMP',"cpu":'$CPU',"ram":'$RAM',"errors":'$ERRORS',"warnings":'$WARNINGS',"cycle":'$CYCLE',"battery":'$BATTERY_INT'}' >> history/summary.json
              COUNT=$((COUNT + 1))
            fi
          fi
        done
        
        echo ']}' >> history/summary.json
        
        # Обновляем count в JSON
        jq --arg count "$COUNT" '.count = ($count|tonumber)' history/summary.json > history/summary.tmp && mv history/summary.tmp history/summary.json
        
        echo "Summary.json created with $COUNT data points"
        
    - name: Commit and push changes
      run: |
        git config --global user.email "github-actions@users.noreply.github.com"
        git config --global user.name "GitHub Actions"
        
        git add history/
        git commit -m "Auto-save bot history [$(date -u '+%H:%M UTC')]" || echo "No changes to commit"
        git push
