<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ü§ñ IFBot Status</title>

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#4f8cff">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --text:#1f2937;
  --muted:#6b7280;
  --primary:#4f8cff;
  --ok:#22c55e;
  --warn:#f59e0b;
  --err:#ef4444;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,system-ui,Inter;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:520px;
  margin:auto;
  padding:14px;
}

/* HEADER */
.header{
  background:var(--card);
  border-radius:18px;
  padding:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.06);
  text-align:center;
}
.status{
  margin-top:10px;
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:8px 14px;
  border-radius:14px;
  background:#eef2ff;
}
.dot{
  width:10px;
  height:10px;
  border-radius:50%;
  background:var(--ok);
  animation:pulse 2s infinite;
}
@keyframes pulse{
  0%{opacity:.3}
  50%{opacity:1}
  100%{opacity:.3}
}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin:16px 0;
}
.card{
  background:var(--card);
  border-radius:14px;
  padding:14px;
  box-shadow:0 6px 20px rgba(0,0,0,.05);
}
.label{
  font-size:12px;
  color:var(--muted);
}
.value{
  font-size:22px;
  font-weight:700;
  margin-top:6px;
}

/* BATTERY */
.battery{
  width:48px;
  height:22px;
  border:2px solid #cbd5e1;
  border-radius:8px;
  position:relative;
}
.battery::after{
  content:"";
  position:absolute;
  right:-4px;
  top:50%;
  width:4px;
  height:12px;
  background:#cbd5e1;
  transform:translateY(-50%);
}
.level{
  height:100%;
  background:linear-gradient(90deg,#22c55e,#16a34a);
  border-radius:6px;
  width:0%;
  transition:width .6s;
}

/* GRAPH */
.graph{
  background:var(--card);
  border-radius:16px;
  padding:14px;
  box-shadow:0 6px 20px rgba(0,0,0,.05);
}
canvas{
  width:100%!important;
  height:220px!important;
}

/* LOGS */
.logs{
  margin-top:16px;
  background:var(--card);
  border-radius:14px;
  padding:14px;
  box-shadow:0 6px 20px rgba(0,0,0,.05);
  font-family:monospace;
  font-size:12px;
  max-height:220px;
  overflow:auto;
}
.log{
  padding:4px 0;
  border-bottom:1px solid #e5e7eb;
}
.log.error{color:var(--err)}
.log.warn{color:var(--warn)}
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <h2>ü§ñ IFBot</h2>
    <div class="status">
      <div class="dot" id="statusDot"></div>
      <span id="statusText">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="label">–¶–∏–∫–ª</div>
      <div class="value" id="cycle">‚Äî</div>
    </div>

    <div class="card">
      <div class="label">–ë–∞—Ç–∞—Ä–µ—è</div>
      <div style="display:flex;align-items:center;gap:10px;margin-top:6px">
        <div class="battery"><div class="level" id="batteryLevel"></div></div>
        <div class="value" id="batteryText">‚Äî%</div>
      </div>
    </div>
  </div>

  <div class="graph">
    <canvas id="cycleChart"></canvas>
  </div>

  <div class="logs" id="logs">
    <div class="log">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤‚Ä¶</div>
  </div>

</div>

<script>
const DATA_URL =
  "https://raw.githubusercontent.com/dimb9ih/dimb9ih.github.io/master/ifbot_stats.json";

let chart;
let history = [];

async function loadData(){
  try{
    const r = await fetch(DATA_URL + "?t=" + Date.now());
    if(!r.ok) throw new Error("HTTP " + r.status);
    const d = await r.json();
    updateUI(d);
  }catch(e){
    document.getElementById("statusText").textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
    document.getElementById("statusDot").style.background = "var(--err)";
  }
}

function updateUI(d){
  document.getElementById("cycle").textContent =
    d.cycle_count ?? "‚Äî";

  document.getElementById("statusText").textContent =
    d.bot_status ?? "‚Äî";

  const battery = parseInt(d.battery_info?.battery_level || 0);
  document.getElementById("batteryLevel").style.width = battery + "%";
  document.getElementById("batteryText").textContent = battery + "%";

  const dot = document.getElementById("statusDot");
  dot.style.background =
    battery < 20 ? "var(--warn)" : "var(--ok)";

  // HISTORY
  if(typeof d.cycle_count === "number"){
    history.push({
      x: new Date(),
      y: d.cycle_count
    });
    if(history.length > 50) history.shift();
    updateChart();
  }

  // LOGS
  if(d.last_log){
    const lines = d.last_log.split("\n").slice(-20);
    const box = document.getElementById("logs");
    box.innerHTML = "";
    lines.forEach(l=>{
      const div = document.createElement("div");
      div.className = "log" +
        (l.includes("ERROR") ? " error" :
         l.includes("WARN") ? " warn" : "");
      div.textContent = l;
      box.appendChild(div);
    });
  }
}

function updateChart(){
  if(!chart){
    chart = new Chart(
      document.getElementById("cycleChart"),
      {
        type:"line",
        data:{
          datasets:[{
            label:"–¶–∏–∫–ª—ã",
            data:history,
            borderColor:"#4f8cff",
            tension:.3
          }]
        },
        options:{
          responsive:true,
          plugins:{legend:{display:false}},
          scales:{
            x:{type:"time"},
            y:{beginAtZero:true}
          }
        }
      }
    );
  }else{
    chart.data.datasets[0].data = history;
    chart.update();
  }
}

// PWA
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("/service-worker.js");
}

loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>
