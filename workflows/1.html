<!-- –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –¥–æ–±–∞–≤—å—Ç–µ: -->
<div class="graph-controls">
    <select id="timeRange" onchange="loadHistoryData()">
        <option value="1">1 —á–∞—Å</option>
        <option value="6">6 —á–∞—Å–æ–≤</option>
        <option value="24" selected>24 —á–∞—Å–∞</option>
        <option value="168">1 –Ω–µ–¥–µ–ª—è</option>
    </select>
    <button onclick="loadHistoryData(true)">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
async function loadHistoryData(forceRefresh = false) {
    try {
        const timeRange = document.getElementById('timeRange').value;
        const hours = parseInt(timeRange);
        
        // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–¥–Ω—ã–π —Ñ–∞–π–ª
        const summaryUrl = `https://raw.githubusercontent.com/dimb9ih/dimb9ih.github.io/master/history/summary_24h.json?t=${Date.now()}`;
        
        const response = await fetch(summaryUrl);
        if (response.ok) {
            const summary = await response.json();
            
            if (summary.data_points && summary.data_points.length > 0) {
                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –¥–∏–∞–ø–∞–∑–æ–Ω—É –≤—Ä–µ–º–µ–Ω–∏
                const cutoffTime = Date.now() / 1000 - (hours * 3600);
                const filteredData = summary.data_points.filter(point => 
                    point.t > cutoffTime
                );
                
                updateChartWithHistory(filteredData);
                return;
            }
        }
        
        // –ï—Å–ª–∏ —Å–≤–æ–¥–Ω—ã–π —Ñ–∞–π–ª –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
        await loadIndividualHistoryFiles(hours);
        
    } catch (error) {
        console.error('Error loading history:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏', 'error');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
async function loadIndividualHistoryFiles(hours) {
    try {
        // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
        const indexUrl = 'https://raw.githubusercontent.com/dimb9ih/dimb9ih.github.io/master/history/index.txt';
        const indexResponse = await fetch(indexUrl);
        
        if (!indexResponse.ok) {
            throw new Error('Cannot load history index');
        }
        
        const indexText = await indexResponse.text();
        const files = indexText.split('\n').filter(line => line.trim());
        
        // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Ñ–∞–π–ª–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–∞—Å–æ–≤
        const filesToLoad = Math.min(files.length, hours * 2); // –ü—Ä–∏–º–µ—Ä–Ω–æ 2 —Ñ–∞–π–ª–∞ –≤ —á–∞—Å
        const recentFiles = files.slice(-filesToLoad);
        
        const historyData = [];
        const cutoffTime = Date.now() / 1000 - (hours * 3600);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
        for (const file of recentFiles) {
            try {
                const fileUrl = `https://raw.githubusercontent.com/dimb9ih/dimb9ih.github.io/master/history/${file}`;
                const response = await fetch(fileUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.timestamp > cutoffTime) {
                        historyData.push({
                            t: data.timestamp,
                            cpu: data.system_stats?.cpu?.utilization_percent || 0,
                            ram: data.system_stats?.memory?.utilization_percent || 0,
                            errors: data.error_stats?.errors || 0,
                            warnings: data.error_stats?.warnings || 0,
                            cycle: data.cycle_count || 0,
                            battery: parseInt(data.battery_info?.battery_level || 0)
                        });
                    }
                }
            } catch (e) {
                console.warn(`Failed to load ${file}:`, e);
            }
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        historyData.sort((a, b) => a.t - b.t);
        
        updateChartWithHistory(historyData);
        
    } catch (error) {
        console.error('Error loading individual files:', error);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
function updateChartWithHistory(historyData) {
    if (!historyData || historyData.length < 2) {
        console.log('Not enough history data');
        return;
    }
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Chart.js
    const labels = historyData.map(item => 
        new Date(item.t * 1000).toLocaleTimeString('ru-RU', { 
            hour: '2-digit', 
            minute: '2-digit' 
        })
    );
    
    const datasets = [
        {
            label: '–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä %',
            data: historyData.map(item => item.cpu),
            borderColor: '#FF6B6B',
            backgroundColor: 'rgba(255, 107, 107, 0.1)',
            borderWidth: 2,
            tension: 0.4
        },
        {
            label: '–ü–∞–º—è—Ç—å %',
            data: historyData.map(item => item.ram),
            borderColor: '#4ECDC4',
            backgroundColor: 'rgba(78, 205, 196, 0.1)',
            borderWidth: 2,
            tension: 0.4
        }
    ];
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
    updateChart(labels, datasets);
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
function updateChart(labels, datasets) {
    const ctx = document.getElementById('statsChart').getContext('2d');
    
    if (window.statsChart) {
        window.statsChart.destroy();
    }
    
    window.statsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: '–ü—Ä–æ—Ü–µ–Ω—Ç—ã (%)'
                    }
                }
            }
        }
    });
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadHistoryData();
    
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    setInterval(() => {
        loadHistoryData();
    }, 300000);
});
</script>
