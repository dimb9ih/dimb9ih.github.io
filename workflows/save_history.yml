yaml
name: Save Bot History

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
    - cron: '*/30 * * * *'
  workflow_dispatch:  # –†–∞–∑—Ä–µ—à–∏—Ç—å —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  save-history:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Download current stats
      run: |
        # –°–∫–∞—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π JSON
        curl -s -o current.json https://raw.githubusercontent.com/dimb9ih/dimb9ih.github.io/master/ifbot_stats.json
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø—É—Å—Ç–æ–π
        if [ -s current.json ]; then
          echo "‚úÖ JSON downloaded successfully"
          cat current.json | jq '.timestamp_human' || echo "Could not parse JSON"
        else
          echo "‚ùå Failed to download JSON"
          exit 1
        fi
        
    - name: Create history directory
      run: |
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
        mkdir -p history
        mkdir -p history/daily
        
        echo "Created history directories"
        
    - name: Save history file
      run: |
        # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
        TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
        FILENAME="ifbot_${TIMESTAMP}.json"
        
        # –¢–∞–∫–∂–µ —Å–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –¥–Ω—è
        DATE_FOLDER=$(date -u +"%Y/%m/%d")
        DAILY_PATH="history/daily/${DATE_FOLDER}"
        mkdir -p "${DAILY_PATH}"
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª –≤ –æ–±–µ –ø–∞–ø–∫–∏
        cp current.json "history/${FILENAME}"
        cp current.json "${DAILY_PATH}/${FILENAME}"
        
        echo "üìÅ Saved to: history/${FILENAME}"
        echo "üìÅ Daily copy: ${DAILY_PATH}/${FILENAME}"
        
        # –°–æ–∑–¥–∞–µ–º index —Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
        ls -1 history/ifbot_*.json | sort -r > history/index.txt
        wc -l history/index.txt
        
    - name: Clean old files (keep last 1000)
      run: |
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 —Ñ–∞–π–ª–æ–≤
        cd history
        FILES_COUNT=$(ls ifbot_*.json | wc -l)
        
        if [ $FILES_COUNT -gt 1000 ]; then
          echo "Cleaning old files... ($FILES_COUNT > 1000)"
          # –£–¥–∞–ª—è–µ–º —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
          ls -1 ifbot_*.json | sort | head -n $(($FILES_COUNT - 1000)) | xargs rm -f
          echo "Removed $(($FILES_COUNT - 1000)) old files"
        else
          echo "No cleaning needed ($FILES_COUNT files)"
        fi
        
    - name: Create summary JSON
      run: |
        # –°–æ–∑–¥–∞–µ–º —Å–≤–æ–¥–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        python3 -c "
import json
import os
from datetime import datetime, timedelta

# –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
files = []
for f in os.listdir('history'):
    if f.startswith('ifbot_') and f.endswith('.json'):
        try:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Ä–µ–º—è –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            ts_str = f[6:21]  # ifbot_YYYYMMDD_HHMMSS.json
            dt = datetime.strptime(ts_str, '%Y%m%d_%H%M%S')
            if datetime.now() - dt < timedelta(days=1):
                files.append(f)
        except:
            pass

# –ß–∏—Ç–∞–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
data_points = []
for f in sorted(files)[-96:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 96 —Ç–æ—á–µ–∫ (24 —á–∞—Å–∞ * 4 –≤ —á–∞—Å)
    try:
        with open(f'history/{f}', 'r') as file:
            data = json.load(file)
            
            point = {
                't': data.get('timestamp', 0),
                'cpu': data.get('system_stats', {}).get('cpu', {}).get('utilization_percent', 0),
                'ram': data.get('system_stats', {}).get('memory', {}).get('utilization_percent', 0),
                'errors': data.get('error_stats', {}).get('errors', 0),
                'warnings': data.get('error_stats', {}).get('warnings', 0),
                'cycle': data.get('cycle_count', 0),
                'battery': int(data.get('battery_info', {}).get('battery_level', 0))
            }
            
            if point['t'] > 0:
                data_points.append(point)
    except:
        pass

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤–æ–¥–Ω—ã–π —Ñ–∞–π–ª
summary = {
    'last_update': datetime.now().isoformat(),
    'data_points': data_points,
    'total_points': len(data_points)
}

with open('history/summary_24h.json', 'w') as f:
    json.dump(summary, f, indent=2)

print(f'Created summary with {len(data_points)} data points')
"
        
    - name: Commit and push
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add history/
        git commit -m "ü§ñ Auto-save bot history - $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || echo "No changes to commit"
        git push origin HEAD:master
